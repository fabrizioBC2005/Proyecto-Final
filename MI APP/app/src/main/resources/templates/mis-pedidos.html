<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Mis pedidos - Glovo Perú</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-light">

  <div th:replace="~{fragments/navbar :: navbar}"></div>

  <div class="container py-5">
    <h2 class="mb-4">Mis pedidos</h2>

    <!-- Mensajes de cancelación -->
    <div th:if="${param.cancelOk}" class="alert alert-success">
      El pedido fue cancelado correctamente.
    </div>
    <div th:if="${param.cancelError}" class="alert alert-danger">
      No se pudo cancelar el pedido.
    </div>

    <!-- Mensajes de eliminación -->
    <div th:if="${param.deleteOk}" class="alert alert-success">
      El pedido fue eliminado correctamente.
    </div>
    <div th:if="${param.deleteError}" class="alert alert-danger">
      No se pudo eliminar el pedido.
    </div>

    <!-- Sin pedidos -->
    <div th:if="${#lists.isEmpty(pedidos)}" class="alert alert-info">
      Aún no tienes pedidos registrados.
    </div>

    <!-- Con pedidos -->
    <div th:if="${!#lists.isEmpty(pedidos)}">
      <div class="accordion" id="accordionPedidos">
        <div class="accordion-item mb-2" th:each="pedido, idx : ${pedidos}">
          <h2 class="accordion-header" th:attr="id='heading' + ${idx.index}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              th:attr="data-bs-target='#collapse' + ${idx.index}" aria-expanded="false"
              th:attrappend=" aria-controls='collapse' + ${idx.index}">
              Pedido #<span th:text="${pedido.id}"></span> -
              <span th:text="${#temporals.format(pedido.fechaCreacion, 'dd/MM/yyyy HH:mm')}"></span>
              &nbsp; | &nbsp;
              <!-- Estado como badge -->
              <span class="badge ms-1" th:classappend="${pedido.estado.name() == 'PENDIENTE'      ? ' bg-warning text-dark' :
                       pedido.estado.name() == 'PAGO_PENDIENTE' ? ' bg-info text-dark' :
                       pedido.estado.name() == 'PAGADO'         ? ' bg-primary' :
                       pedido.estado.name() == 'EN_CAMINO'      ? ' bg-primary badge-en-camino' :
                       pedido.estado.name() == 'ENTREGADO'      ? ' bg-success' :
                       ' bg-secondary'}" th:text="${pedido.estado}">
              </span>

              &nbsp; | Total: S/ <span th:text="${pedido.total}"></span>
            </button>
          </h2>

          <div class="accordion-collapse collapse" th:attr="id='collapse' + ${idx.index}"
            th:attrappend=" aria-labelledby='heading' + ${idx.index}" data-bs-parent="#accordionPedidos">
            <div class="accordion-body">
              <p>
                <strong>Dirección:</strong>
                <span th:text="${pedido.direccionEntrega}"></span><br>

                <strong>Referencia:</strong>
                <!-- ✅ corregido: ternario bien escrito -->
                <span th:text="${pedido.referencia != null ? pedido.referencia : '—'}"></span><br>

                <strong>Método de pago:</strong>
<span th:switch="${pedido.metodoPago}">
  <span th:case="${T(com.glovo.app.entity.MetodoPago).CONTRAENTREGA}">Contraentrega</span>
  <span th:case="${T(com.glovo.app.entity.MetodoPago).TARJETA}">Tarjeta</span>
  <span th:case="${T(com.glovo.app.entity.MetodoPago).YAPE}">Yape / Plin</span>
  <span th:case="*">-</span>
</span>
<br>

<strong>Estado de pago:</strong>
<span class="badge"
      th:classappend="${pedido.estadoPago.name() == 'PENDIENTE' ? ' bg-warning text-dark' :
                       pedido.estadoPago.name() == 'PAGADO'    ? ' bg-success' :
                       pedido.estadoPago.name() == 'CANCELADO' ? ' bg-secondary' :
                       ' bg-danger'}"
      th:text="${pedido.estadoPago}">
</span><br>
</p>

              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Servicio</th>
                    <th>Cant.</th>
                    <th>Precio</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="det : ${pedido.detalles}">
                    <td th:text="${det.nombreProducto}"></td>
                    <td th:text="${det.servicio}"></td>
                    <td th:text="${det.cantidad}"></td>
                    <td>S/ <span th:text="${det.precioUnitario}"></span></td>
                    <td>S/ <span th:text="${det.subtotal}"></span></td>
                  </tr>
                </tbody>
              </table>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <!-- Ver detalle/tracking -->
                <a th:href="@{'/pedido/' + ${pedido.id}}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-eye"></i> Ver detalle
                </a>

                <!-- Repetir pedido -->
                <form th:action="@{'/pedido/' + ${pedido.id} + '/repetir'}" method="post" class="d-inline">
                  <button class="btn btn-outline-success btn-sm" type="submit">
                    <i class="bi bi-arrow-repeat"></i> Volver a pedir
                  </button>
                </form>

                <!-- Cancelar (si se puede) -->
                <form th:if="${pedido.estado.name() != 'ENTREGADO' and pedido.estado.name() != 'CANCELADO'}"
                  th:action="@{'/pedido/' + ${pedido.id} + '/cancelar'}" method="post" class="d-inline"
                  onsubmit="return confirm('¿Seguro que deseas cancelar este pedido?');">
                  <button class="btn btn-outline-danger btn-sm" type="submit">
                    <i class="bi bi-x-circle"></i> Cancelar
                  </button>
                </form>

                <!-- PDF siempre disponible -->
                <a th:href="@{'/mis-pedidos/' + ${pedido.id} + '/pdf'}" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-file-earmark-pdf"></i> PDF
                </a>

                <!-- Eliminar DEFINITIVAMENTE (solo ENTREGADO o CANCELADO) -->
                <form th:if="${pedido.estado.name() == 'ENTREGADO' or pedido.estado.name() == 'CANCELADO'}"
                  th:action="@{'/pedido/' + ${pedido.id} + '/eliminar'}" method="post" class="d-inline"
                  onsubmit="return confirm('Este pedido se eliminará permanentemente. ¿Continuar?');">
                  <button class="btn btn-sm btn-outline-dark" type="submit">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </form>

              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>