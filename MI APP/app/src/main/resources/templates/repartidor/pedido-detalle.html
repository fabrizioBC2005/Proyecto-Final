<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Detalle del pedido</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* Stepper simple: Pendiente → En camino → Entregado */
    .pedido-stepper {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 1.5rem;
      position: relative;
    }

    .pedido-stepper::before {
      content: "";
      position: absolute;
      top: 22px;
      left: 12%;
      right: 12%;
      height: 3px;
      background: #e5e7eb;
      z-index: 0;
    }

    .pedido-step {
      position: relative;
      z-index: 1;
      text-align: center;
      flex: 1 1 0;
    }

    .pedido-step-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      margin: 0 auto 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 700;
      background: #e5e7eb;
      color: #374151;
    }

    .pedido-step-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: #6b7280;
    }

    .pedido-step.completed .pedido-step-circle {
      background: #16a34a;
      color: #fff;
    }

    .pedido-step.current .pedido-step-circle {
      background: #3b82f6;
      color: #fff;
    }

    .pedido-step.completed .pedido-step-label,
    .pedido-step.current .pedido-step-label {
      color: #111827;
    }
  </style>
</head>
<body class="bg-light">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container py-4">
  <a th:href="@{/repartidor/pedidos}" class="btn btn-link mb-3">
    ← Volver a pedidos
  </a>

  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="card-title mb-3">
        Detalle del pedido #<span th:text="${pedido.id}"></span>
      </h4>

      <!-- Stepper de estado -->
      <div class="pedido-stepper">
        <!-- 1. PENDIENTE -->
        <div class="pedido-step"
             th:classappend="${
                 pedido.estado.name() == 'PENDIENTE'        ? ' current' :
                 (pedido.estado.name() == 'EN_CAMINO' or pedido.estado.name() == 'ENTREGADO') ? ' completed' :
                                                                                               ''
             }">
          <div class="pedido-step-circle">
            <span th:text="${pedido.estado.name() == 'EN_CAMINO' or pedido.estado.name() == 'ENTREGADO' ? '✓' : '1'}"></span>
          </div>
          <div class="pedido-step-label">Pendiente</div>
        </div>

        <!-- 2. EN CAMINO -->
        <div class="pedido-step"
             th:classappend="${
                pedido.estado.name() == 'EN_CAMINO' ? ' current' :
                pedido.estado.name() == 'ENTREGADO' ? ' completed' :
                                                     ''
             }">
          <div class="pedido-step-circle">
            <span th:text="${pedido.estado.name() == 'ENTREGADO' ? '✓' : '2'}"></span>
          </div>
          <div class="pedido-step-label">En camino</div>
        </div>

        <!-- 3. ENTREGADO -->
        <div class="pedido-step"
             th:classappend="${pedido.estado.name() == 'ENTREGADO' ? ' current' : ''}">
          <div class="pedido-step-circle">
            <span th:text="${pedido.estado.name() == 'ENTREGADO' ? '✓' : '3'}"></span>
          </div>
          <div class="pedido-step-label">Entregado</div>
        </div>
      </div>

      <!-- Estado / fecha / total -->
      <p class="mb-1">
        <strong>Estado actual:</strong>
        <span class="badge"
              th:classappend="${
                pedido.estado.name() == 'PENDIENTE'      ? ' bg-warning text-dark' :
                pedido.estado.name() == 'PAGO_PENDIENTE' ? ' bg-info text-dark' :
                pedido.estado.name() == 'PAGADO'         ? ' bg-primary' :
                pedido.estado.name() == 'EN_CAMINO'      ? ' bg-primary badge-en-camino' :
                pedido.estado.name() == 'ENTREGADO'      ? ' bg-success' :
                                                            ' bg-secondary'
              }"
              th:text="${pedido.estado}">
        </span>
      </p>
      <p class="mb-1">
        <strong>Fecha:</strong>
        <span th:text="${#temporals.format(pedido.fechaCreacion, 'dd/MM/yyyy HH:mm')}"></span>
      </p>
      <p class="mb-3">
        <strong>Total:</strong>
        S/ <span th:text="${pedido.total}"></span>
      </p>

      <!-- Cliente -->
      <h5>Cliente</h5>
      <p class="mb-2" th:if="${pedido.usuario != null}">
        <strong>ID:</strong> <span th:text="${pedido.usuario.id}"></span><br>
        <strong>Nombre:</strong>
        <span th:text="${pedido.usuario.nombre + ' ' + pedido.usuario.apellido}"></span><br>
        <strong>Email:</strong> <span th:text="${pedido.usuario.email}"></span>
      </p>

      <!-- Envío -->
      <h5 class="mt-3">Dirección de entrega</h5>
      <p class="mb-2">
        <strong>Dirección:</strong>
        <span th:text="${pedido.direccionEntrega}"></span><br>
        <strong>Referencia:</strong>
        <span th:text="${pedido.referencia != null ? pedido.referencia : '—'}"></span><br>
        <strong>Método de pago:</strong>
        <span th:text="${pedido.metodoPago}"></span>
      </p>

      <!-- Productos -->
      <h5 class="mt-3">Productos</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
          <tr>
            <th>Producto</th>
            <th>Servicio</th>
            <th class="text-center">Cantidad</th>
            <th class="text-end">Precio</th>
            <th class="text-end">Subtotal</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="det : ${pedido.detalles}">
            <td th:text="${det.nombreProducto}"></td>
            <td th:text="${det.servicio}"></td>
            <td class="text-center" th:text="${det.cantidad}"></td>
            <td class="text-end">S/ <span th:text="${det.precioUnitario}"></span></td>
            <td class="text-end">S/ <span th:text="${det.subtotal}"></span></td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Botones rápido abajo -->
      <div class="mt-3 d-flex gap-2 flex-wrap">
        <form th:action="@{'/repartidor/pedidos/' + ${pedido.id} + '/en-camino'}"
              method="post">
          <button class="btn btn-outline-primary btn-sm"
                  th:disabled="${pedido.estado.name() != 'PENDIENTE' and pedido.estado.name() != 'PAGO_PENDIENTE' and pedido.estado.name() != 'PAGADO'}">
            Marcar EN CAMINO
          </button>
        </form>

        <form th:action="@{'/repartidor/pedidos/' + ${pedido.id} + '/entregado'}"
              method="post">
          <button class="btn btn-success btn-sm"
                  th:disabled="${pedido.estado.name() == 'ENTREGADO'}">
            Marcar ENTREGADO
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
